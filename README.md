 ## 项目功能总览

本项目是一个基于 Windows 平台的微信工具与 AI 助手综合应用，集成了微信消息收发、联系人与群成员读取、批量/定时群发、自动化加好友、备注管理、消息监听与解析、自动回复（规则与 AI）、以及完整的 AI 助手（对话/文案优化/文档总结）等功能。GUI 采用 PySide6 开发，底层对微信的能力通过进程内存读写与 Frida Hook 实现；AI 能力支持多家厂商（OpenAI、Anthropic、Google、SiliconFlow、腾讯混元、字节豆包、阿里通义、百度文心、以及本地）并可配置模型与参数。

---

## 模块结构与职责

### `main.py`（应用主界面与业务编排）
- GUI 主窗口与多标签页：账号管理、加好友、自动回复、任务/群发、AI 助手等。
- 批量与定时任务：创建/更新/执行/删除任务，定时发送文本/图片，支持随机间隔，任务表展示与刷新。
- 消息发送入口：
  - 个人和群聊文本消息发送。
  - 图片发送（调用底层能力）。
  - 失败处理回退逻辑。
- 联系人与群：
  - 拉取微信联系人（含过滤常见系统账号），区分好友与群聊。
  - 获取群成员列表（含昵称解析），支持按群批量操作。
  - 列表搜索/筛选、右键菜单操作、导出为 Excel/CSV。
- 自动回复系统（人设/规则/AI）：
  - 规则开关（总开关、好友/群、指定好友/群、模糊/精确匹配）。
  - 新好友欢迎、最小/最大回复间隔防刷。
  - AI 回复模式二选一：
    - 大模型直答（支持系统提示、风格、表情、温度、token 限制）。
    - “元宝客服”转发（把问题发给指定微信号，等待人工/客服响应；含发送者与群聊映射记录）。
  - 回复内容的记录与导出、历史清理。
- 规则管理：
  - 新增/删除/清空、导入/导出、批量选择/反选、启用状态复选框。
  - 配置持久化到 `config/auto_reply_rules.json`。
- 监控与消息接收：
  - 基于 `WeChatMessageMonitor`（Frida）启动/停止监听。
  - 解析消息（含群消息的成员 ID、XML 特殊消息解析），触发自动回复流程。
- 备注管理与加好友：
  - 修改好友备注（含静默方式）。
  - 通过手机号/群成员批量添加好友（带打招呼语与节流）。
  - 根据“同意加好友”的昵称反向应用备注。
- 数据持久化与导出：
  - 消息与账号数据保存/加载；历史筛选与导出。
  - `DataManager` 负责消息记录、清理过期数据、加载全部账号数据等。
- 统计与监控：
  - 统计总消息数、AI 回复数、自动回复数、错误数、响应时间等。
  - 监听状态检查（是否活跃）。

### `wechat.py`（微信底层能力：内存读写/远程线程/Frida Hook）
- 进程与模块：打开微信进程句柄、查找 `WeChatWin.dll` 基址、模块遍历与基址缓存。
- 内存读写：通用的 Read/Write、UTF-16/UTF-8 字符串解码工具、结构体写入。
- 账号信息：读取登录账号的昵称、wxid、手机号（多偏移回退，容错）。
- 联系人与群：
  - 读取联系人列表（wxid/昵称/备注/是否群聊/手机号推断）。
  - 读取群成员列表（带昵称解析）。
- 消息能力：
  - 发送文本：构造远程线程与 shellcode 调用微信内部函数。
  - 发送图片：路径注入 + 调用多段内部函数（失败时回退发送路径文本）。
- 好友与备注：
  - 通过 wxid/手机号添加好友（场景值可配，自动填充打招呼语）。
  - 修改好友备注（内联跳过关键检查字节，调用内部函数后恢复）。
- Frida 监听：
  - `WeChatMessageMonitor`：Hook 指定偏移，捕获消息（时间戳、wxid、内容、群成员 ID），并解析 XML 特殊消息（语音/图片/视频/转账/位置/链接/表情等）。
  - `ContactInfoMonitor`：Hook 联系人详情场景，抓取手机号、v3 编码、昵称等。
- 环境辅助：启动新微信实例、检测安装路径、检测运行进程。

### `aizhuli_combined.py`（AI 助手与配置）
- `APIManager`：
  - 统一管理多家厂商参数：`api_base`、`api_key`、`timeout`、`models`、`current_provider`。
  - 读写 `config/api.json`，保存为带 `providers` 的新格式；支持新增/删除服务商与模型。
  - 请求头封装与默认模型选择。
- `PromptManager`：
  - 丰富的提示词模板：
    - chat：general/code/life
    - optimize：article/poetry/greeting
    - summary：document/meeting/excel
  - 模板持久化到 `config/prompts.json`。
- `ChatManager`：
  - 历史记录到 `config/messages.ini`（INI 持久化），按时间排序与清理。
- `AIManager`：
  - 同步与异步的 `chat_completion`（HTTP POST 到 `/chat/completions`），支持启用/禁用规则与风格、温度、token 限制、表情指令、前缀等。
  - 流式模拟输出、批量处理、连通性测试。
  - “元宝客服”模式：通过 `wechat.py` 把问题转发到固定客服 wxid，并记录最近发送者与群聊 ID 的映射。
  - 自动回复设置默认值与加载保存（`auto_reply_rules.json` 中 `settings`）。
- `AIAssistantTab`（AI 助手 GUI）：
  - API 设置区：选择服务商、设置 `api_base`/`api_key`、模型列表、测试连接、保存配置。
  - AI 功能区：
    - AI 对话：自动按内容切到 general/code/life 模板。
    - AI 美文优化：
      - 弹窗配置风格（预设/自定义）、字数（预设/自定义/不限制）、创意与保留原意滑块、表情程度、版本数（并行生成多版本）。
    - 文档总结：文件选择（txt/docx/xlsx/pdf），模板与字数约束，自定义要求；内置 docx(XML) 与 xlsx(openpyxl) 解析，txt 多编码尝试，pdf 作为占位交给大模型处理。
  - 异步生成线程 + 信号回传，按钮状态管理，结果复制/清空。

---

## 关键功能详解

### 1) 账号与联系人/群管理
- 自动检测已登录账号（多进程支持）。
- 读取联系人信息（过滤系统账号/公众号/文件传输助手等）。
- 获取群列表与群成员明细（含昵称），支持批量处理。
- 列表搜索、右键菜单动作、导出为 Excel/CSV。

### 2) 消息收发
- 文本与图片消息发送（个人与群聊）。
- 失败回退（图片失败时回退成“文件路径”文本消息）。
- 统一失败处理提示与日志记录。

### 3) 消息监听与解析
- Frida Hook 指定函数偏移，解析 RDI/R9 等寄存器结构读取消息字段。
- XML 特殊消息解析：语音/图片/视频/文件/链接/位置/红包/转账/表情/音乐等。
- 群聊消息附带 `member_id` 便于明确发言人。

### 4) 自动回复系统
- 规则引擎：
  - 规则项（关键词→固定回复）增删改查，启用开关，导入导出。
  - 匹配模式：模糊匹配/精确匹配。
  - 场景：好友/群、指定好友/群、新好友欢迎、最小-最大间隔。
- AI 回复：
  - 大模型直答：系统提示、风格、表情、温度、token 限制可配置。
  - 元宝客服：把消息转发到指定客服微信，记录映射以便后续回发（当前实现等待 10s 后返回空串，不主动回填答案，建议配合监听扩展）。

### 5) 批量与定时任务
- 群发计划：
  - 选择好友/群、设置消息/图片与时间窗，定时执行。
  - 发送间隔随机化（最小/最大延迟）。
  - 任务表展示、编辑、删除、执行与刷新。

### 6) 加好友与备注管理
- 通过 wxid/手机号添加好友：内置流程调用微信内部接口，支持问候语与场景值。
- 批量添加群成员为好友。
- 修改好友备注：
  - UI 交互与静默修改两种方式（直接调用内部函数）。
  - 根据“通过好友申请”的昵称应用备注。

### 7) AI 助手
- 对话与文案优化：多风格、多版本并行生成。
- 文档总结：支持 txt/docx/xlsx/pdf（pdf 直接交由模型分析）。
- 多厂商/多模型：`config/api.json` 可扩展服务商与模型，支持切换与参数设置。
- 历史记录：保存在 INI 文件，便于轻量与可读。

### 8) 数据持久化与导出
- `config/api.json`：服务商列表、当前服务商与模型配置。
- `config/prompts.json`：提示词模板集合。
- `config/auto_reply_rules.json`：自动回复规则与 AI 设置（settings）。
- `config/messages.ini`：聊天历史（INI 结构，按时间排序）。
- 导出：联系人/群成员/历史为 Excel 或 CSV。

### 9) 统计与监控
- 消息统计：消息数、AI 回复数、自动回复数、错误数、响应时间列表。
- 监听状态：是否活跃、心跳检查与错误重试提示。

---

## 配置文件说明
- 目录：`config/`
  - `api.json`：
    - 新格式示例：
      - `providers`：各服务商配置（`api_base`/`api_key`/`name`/`models`）。
      - `current_provider`：当前选中服务商。
      - `last_updated`：时间戳。
  - `prompts.json`：提示词自定义覆盖默认模板。
  - `auto_reply_rules.json`：
    - `rules`：关键词列表。
    - `settings`：自动回复与 AI 的各项开关与参数（温度/风格/表情/模型 token 限制等）。
  - `messages.ini`：聊天历史（节约体积、可手工查看）。

---

## 典型工作流

### 自动回复（AI 直答）
1. 启动消息监听 → 捕获消息 → 规则匹配（命中固定回复）或触发 AI 回复。
2. 生成 `system + user` 的提示词 → 调用当前服务商 `/chat/completions` → 拿到内容。
3. 记录与展示 → 发送回微信（防刷间隔控制）。

### 自动回复（元宝客服）
1. 监听消息 → 触发“元宝客服”模式 → 把用户内容直接发送给客服 wxid。
2. 记录最近发送者与群聊映射（便于后续回发）。
3. 当前实现等待一段时间并返回空串（不额外提示）；可二次开发监听客服回复并转发给用户。

### AI 文案优化（多版本并行）
1. 弹窗设置（风格/字数/表情/创意/保意/版本数）。
2. 并行构造多个提示词角度（价值/体验/表达/共鸣/实用），并行请求模型。
3. UI 汇总展示，支持复制。

---

## 依赖与环境
- 平台：Windows 10/11（64 位），需在装有微信客户端的环境运行。
- 管理员权限：部分功能（内存读写/远程线程/Hook）需要管理员权限，与杀软兼容性需自行评估。
- Python 依赖（核心）：
  - PySide6、psutil、pywin32、openpyxl（Excel 读取）、aiohttp（可选，内置 urllib 退化实现）。
  - Frida/Frida-Tools（可选，用于消息/联系人信息 Hook 监听）。

---

## 安全与合规提示
- 进程内存操作、远程线程与 Hook 技术可能触发安全软件拦截，且可能违反目标软件的服务条款；仅用于学习研究，请勿用于任何违法或违规用途。
- WeChat 内部偏移为特定版本适配，版本升级可能导致偏移失效，需要重新分析与适配。

---

## 已知限制与改进方向
- WeChat 版本强依赖：函数偏移需要根据版本更新。
- 元宝客服回传链路未闭合：当前仅转发问题，未自动回收客服回复并转发给用户。
- 语音对话：功能占位，未实现实时识别/合成。
- 文档类型：旧版 `.doc` 不支持，需另存为 `.docx`；PDF 依赖模型处理质量。
- 并发与速率：批量与并行调用需结合 API 限流策略与稳定性调优。

---

## 快速上手
- 步骤概览：
  1) 登录微信；以管理员运行应用。
  2) 在“AI 助手”页配置服务商与 API Key，测试连接保存。
  3) 在“自动回复”页配置规则或启用 AI 回复模式。
  4) 开启消息监听，观察自动回复效果。
  5) 需要群发/定时发送时，在任务页创建计划并执行。

- 配置文件位置：均位于 `config/` 目录，可手工备份/迁移。

---

## 重要文件一览
- `main.py`：GUI 与业务编排（任务、自动回复、监控、导出等）。
- `wechat.py`：微信底层能力（内存/远程线程/Hook/联系人/消息/加好友/备注）。
- `aizhuli_combined.py`：AI 能力（配置/提示词/对话/优化/总结/与微信融合）。
- `config/`：`api.json`、`prompts.json`、`auto_reply_rules.json`、`messages.ini`。

---

如需扩展（例如适配新版微信、接入新的 AI 厂商或完善客服回传），建议按照模块边界分别修改对应文件并做好配置项的向后兼容与异常保护。
